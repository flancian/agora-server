# Nginx configuration snippet to allowlist ActivityPub traffic while keeping
# the rest of the site protected by HTTP Basic Auth.
#
# WHY USE THIS?
# If you run a development instance (e.g., dev.anagora.org) and want to protect it
# from bots or unauthorized access using HTTP Basic Auth, standard ActivityPub federation
# will fail because remote servers (Mastodon, etc.) cannot authenticate with your password
# when fetching public keys, profiles, or sending to your inbox.
#
# This configuration bypasses Basic Auth for specific ActivityPub endpoints, allowing
# the "Social Graph" to interact with your instance while keeping the "Web UI" private.

# 1. Discovery (WebFinger, NodeInfo)
# Necessary for remote servers to find your users.
location ^~ /.well-known/ {
    auth_basic off;
    
    # REPLACE THE LINES BELOW with your actual proxy configuration
    # e.g., proxy_pass http://127.0.0.1:5000;
    include uwsgi_params;
    uwsgi_pass unix:/tmp/agora.sock; 
}

# 2. Actors (User Profiles)
# e.g., /users/flancian (Fetching Public Keys)
location ^~ /users/ {
    auth_basic off;
    
    include uwsgi_params;
    uwsgi_pass unix:/tmp/agora.sock;
}

# 3. Interactions & Content (Inboxes, Outboxes, Notes)
# e.g., /u/flancian/inbox, /u/flancian/note/...
location ^~ /u/ {
    auth_basic off;
    
    include uwsgi_params;
    uwsgi_pass unix:/tmp/agora.sock;
}

# 4. Shared Inbox
# The global inbox for the instance.
location = /inbox {
    auth_basic off;
    
    include uwsgi_params;
    uwsgi_pass unix:/tmp/agora.sock;
}
