# Nginx configuration snippet to allowlist ActivityPub traffic while keeping
# the rest of the site protected by HTTP Basic Auth.
#
# USAGE:
# 1. Include this file inside your Nginx 'server { ... }' block.
# 2. Ensure 'auth_basic' is set in the server block or specific locations you want to protect.
# 3. Verify the '@agora' block matches your backend (Proxy vs uWSGI).

# --- Backend Definition (Named Location) ---
# Define your backend connection logic ONCE here. 
# The other locations will jump here after bypassing auth.
location @agora {
    # Option A: HTTP Proxy (Default for Dev)
    # Replace IP:PORT with your actual backend address (e.g., 192.168.1.6:5017)
    proxy_pass http://127.0.0.1:5017;
    
    # Standard Proxy Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Option B: uWSGI (Common for Prod)
    # include uwsgi_params;
    # uwsgi_pass unix:/tmp/agora.sock;
    
    # Ensure this block doesn't re-impose auth if jumped to from an allowlisted location
    auth_basic off;
}

# --- ActivityPub Allowlist (Bypass Basic Auth) ---

# 1. Discovery (WebFinger, NodeInfo)
location ^~ /.well-known/ {
    auth_basic off;
    try_files $uri @agora;
}

# 2. Actors (User Profiles)
location ^~ /users/ {
    auth_basic off;
    try_files $uri @agora;
}

# 3. Interactions & Content (Inboxes, Outboxes, Notes)
location ^~ /u/ {
    auth_basic off;
    try_files $uri @agora;
}

# 4. Shared Inbox
location = /inbox {
    auth_basic off;
    try_files $uri @agora;
}

# --- Standard Content (Protected) ---

# 5. Root / Fallback
# This location inherits 'auth_basic' from the server block (if set).
location / {
    try_files $uri @agora;
}